# 格式审计组周报2.14

## 基础信息

- 汇报周期：2026 年 2 月 7 日 — 2026 年 2 月 14 日（第一周）
- 汇报人（组长）：任钰浩
- 汇报日期：2026 年 2 月 14 日
- 小组成员：余晨灿、冯楷睿、马钰堃

## 一、本周项目整体进展

完成小组内人员的分工与安排，完成格式与排版审计智能体环境的搭建，完成项目基础框架的搭建，初步实现智能体的部分审计功能。

### 1.1 核心架构搭建

- 基于 FastAPI 和 Pydantic V2 库构建了异步审计服务
- 集成 PostgreSQL + pgvector 数据库，实现审计结果的实时持久化
- 具备异常处理机制
- 提供 /audit 审计接口、/layout/analyze 布局接口、/health 健康检查
- 参数校验错误统一由自定义异常处理器返回 400，便于跨组对齐
- 应用生命周期在启动时加载规则 / 连接数据库，关闭时安全释放资源
- 审计结果异步写入 review_tasks 表（含分数、等级、原始结果、耗时）
- 支持 rules.yaml 动态规则加载，便于后续在后台热更新
- 统一日志由 LOG_LEVEL 环境变量控制，便于不同部署环境调优
- 依据问题严重度（Critical/Warning/Info）与数量计算扣分并分级

```
agent/                              # 格式审计组项目根目录
├── README.md                       # 项目说明文档
├── Standardization_Auditor_Agent/  # 格式审计智能体主目录
│   ├── main.py                     # FastAPI 应用入口
│   ├── config.py                   # 全局配置管理
│   ├── models.py                   # Pydantic 数据模型
│   ├── requirements.txt            # 项目依赖列表
│   ├── rules.yaml                  # 语义校验规则配置
│   ├── Dockerfile                  # 容器化构建文件
│   ├── ensure_db.py                # 数据库初始化脚本
│   ├── audit_client.py             # 审计客户端
│   ├── api/                        # API 路由层
│   │   ├── __init__.py
│   │   └── layout_routes.py        # 布局分析路由
│   ├── core/                       # 核心业务逻辑层
│   │   ├── database.py             # 数据库连接管理
│   │   ├── rule_engine.py          # 规则引擎 (YAML 配置加载)
│   │   ├── llm_client.py           # LLM 客户端 (Gemini/Qwen)
│   │   ├── prompts.py              # 系统提示词
│   │   ├── layout_analysis.py      # PDF 解析与视觉分析
│   │   ├── layout_zones.py         # 布局区域划分
│   │   ├── layout_rules.py         # 布局校验规则
│   │   ├── layout_schema.py        # 布局数据模型
│   │   ├── layout_payload.py       # 布局数据载荷
│   │   ├── layout_adapter.py       # 布局适配器
│   │   ├── layout_frontend_adapter.py  # 前端适配器
│   │   ├── layout_integration.py   # 布局集成模块
│   │   ├── layout_perf.py          # 布局性能分析
│   │   ├── layout_exceptions.py    # 布局异常定义
│   │   ├── pdf_utils.py            # PDF 工具函数
│   │   ├── vision_utils.py         # 计算机视觉工具
│   │   └── semantic_check.py       # 语义校验模块
│   │       ├── TypoChecker         # 错别字检测
│   │       ├── TerminologyChecker  # 术语一致性检测
│   │       ├── PunctuationChecker  # 标点符号检测
│   │       ├── CitationChecker     # 引用格式检测
│   │       └── SemanticChecker     # 语义校验入口
│   ├── utils/                      # 通用工具库
│   │   ├── __init__.py
│   │   └── logger.py               # 标准化日志模块
│   └── tests/                      # 测试用例
│       ├── __init__.py
│       └── test_api.py             # API 接口测试
└── .idea/                          # IDE 配置目录
    ├── .gitignore
    ├── Agent.iml
    ├── inspectionProfiles/
    │   └── profiles_settings.xml
    ├── misc.xml
    ├── modules.xml
    └── vcs.xml
```

### 1.2 CV / 布局开发

- 基于 PyMuPDF 实现 PDF 解析功能，提取 PDF 中文本、图像、公式等元素，并实现布局区域的识别（标题、正文、图表、公式、参考文献等）
- 基于正则表达式完成图表标号与引用检测：识别 "图 X"、"表 X" 标题，验证正文引用与图表标题的匹配性
- 借助正则表达式实现标题层级检测：检测标题序号跳级、序号不连续等问题
- 借助正则表达式完成公式规范检测：检测公式编号缺失、公式编号未右对齐、公式未在正文引用等问题
- 图表标题位置校验：图标题应位于图下方、表标题应位于表上方
- 正文 “见图 / 表 X” 与对应标题编号双向匹配，缺失即标记 Label_Missing
- 公式编号右对齐通过页面最大 X 坐标比例阈值检测，偏移提示 Misaligned
- 标题层级在可视层基于序号与字号特征联动，检测跳级与不连续
- 引用标注与参考文献区做初步视觉匹配，标记 Citation_Visual_Fault

### 1.3 数据测试 / 标注

- 基于正则表达式初步实现引用与参考文献匹配：验证正文引用如 `[1]`、`(Wang, 2023)` 是否在参考文献列表中有对应条目
- 基于正则表达式初步实现引用风格一致性检测：目前支持 IEEE（数字编号）和 APA（作者 - 年份）两种风格，检测混用问题
- 已建立 rules.yaml 初版，包含 typo/terminology/punctuation/citation 四类规则
- 测试样本与规则联动，支持按学科扩展术语库与禁止写法清单

### 1.4 大模型集成

- 实现了统一的 LLM 客户端封装，支持 Google Gemini 和 Qwen 的切换
- 目前以集成千问 API 作为主要后端（因 Gemini API 无法获取）
- LLM_PROVIDER 支持 gemini/qwen/none 自动降级，缺少密钥不阻塞主流程
- 统一超时控制（环境变量 LLM_TIMEOUT_SEC），保障接口稳定性

### 1.5 测试

- 编写了 test_api.py 和 audit_client.py 测试文件，在已启动 main.py 文件的情况下，直接运行 audit_client.py 脚本会自动生成测试用 PDF 并上传，也可在命令行参数中指定选定的 PDF 文件路径进行测试，最后会在终端上打印 Agent 返回的评分、风险等级和具体问题标签。
- 单测覆盖 /health、/audit 正常用例与参数错误用例（验证 400 返回码）
- 断言 AuditResponse 结构完整性与评分 / 等级字段类型正确性
- 端到端脚本 audit_client.py 支持自动构造含问题样例 PDF

### 1.6 程序逻辑流程图

![流程图](D:\寒假作业\Agent\流程图.png)

**图 1 逻辑流程图**

## 二、成员任务分配与完成情况

| 成员姓名 |                         本周负责任务                         |      分工       |
| :------: | :----------------------------------------------------------: | :-------------: |
|  余晨灿  | 环境搭建（Python 3.10.x ；FastAPI；Pydantic V2），项目基础框架搭建，项目入口 main.py 开发，数据库集成（PostgreSQL；pgvector），负责 main.py、core/database.py、api/layout_routes.py 集成与调通，编写 ensure_db.py 与 utils/logger.py，完成 /audit 与 /layout/analyze 路由联调 |  CV / 布局开发  |
|  冯楷睿  | 图表标号与引用检测、标题层级检测、公式规范检查的初步实现，异常问题处理，实现 core/layout_analysis.py 中 VisualValidator 各规则、layout_rules.py 引用匹配与锚点生成联动，完善图表标题位置与公式右对齐校验 |  CV / 布局开发  |
|  马钰堃  | 大模型 API 准备（千问 API ），LLM 客户端封装，测试文件编写（test_api.py，audit_client.py），完成 core/llm_client.py 统一封装与 provider 自动降级；补充 tests/test_api.py 覆盖度；提供端到端调试脚本 audit_client.py |    语义判定     |
|  任钰浩  | 组织人员分工，协助完成环境搭建，术语一致性检测、引用风格一致性检测初步实现，梳理 rules.yaml 术语 / 标点 / 引用规则项，制定初版标注规范与验证口径，牵头周报与需求对齐 | 数据测试 / 标注 |

## 三、本周遇到的问题与解决措施

|         问题描述         |              已采取的解决措施               | 是否解决（是 / 否） |                           后续计划                           |
| :----------------------: | :-----------------------------------------: | :-----------------: | :----------------------------------------------------------: |
| Gemini 模型 API 无法获取 | 临时采用千问 API，实现统一的 LLM 客户端封装 |         是          | 比较其他国内大模型如 DeepSeek-V3、DeepSeek-Reasoner (R1)、 GLM-4 效果，择优选择 |
|  当前审计结果正确性存疑  |                     无                      |         否          | 收集更多样本，借助大模型进一步提高审计结果准确性，完善规则引擎的 YAML 配置 |
|      数据库无法连接      |           由指导老师指导完成连接            |         是          |                              无                              |

## 四、下周工作计划

### 4.1 核心目标

进一步完善目前已初步实现的审计功能，实现错别字红线判定、术语一致性检测等功能，借助大模型辅助扫描和审计，提升审计结果准确性。

### 4.2 分成员任务计划

#### 余晨灿（CV / 布局开发）

- 优化 PDF 解析性能，引入多线程处理提升解析速度
- 进一步完善图表标号与引用检测功能
- 与前端适配，实现审计结果的可视化展示
- 完善多列版式检测与正文字号自适应估计，提升视觉规则稳定性
- 输出标准化前端锚点 payload（elements/anchors），联调前端跳转高亮

#### 冯楷睿（CV / 布局开发）

- 优化大模型 Prompt，提高复杂格式问题的识别准确率
- 进一步完善公式规范检测功能，如更加精确地判断公式编号右侧是否对齐
- 扩展图表标题 - 图像关联策略（跨页 / 并列图表），降低误检漏检
- 补充标题层级边缘场景（如附录 / 参考文献章节编号特殊处理）

#### 马钰堃（语义判定）

- 实现错别字红线判定逻辑
- 实现术语一致性检测功能
- 进一步完善测试文件，增加边界条件测试
- 实现标点符号混用 / 位置校验；集成规则热更新钩子 reload ()
- 补充 AuditResponse JSON Schema 校验用例与异常路径覆盖

#### 任钰浩（数据测试 / 标注）

- 借助大模型，进一步完善引用一致性检测功能
- 收集更多格式错误样本，完善规则引擎的 YAML 配置
- 完善标注手册与术语库维护流程，建立样本 - 规则联动更新机制

### 4.3 其他改进计划

- 优化评分算法，根据问题严重程度和位置权重计算更合理的分数
- 开发审计报告生成功能，支持导出 Markdown/Word/PDF 格式